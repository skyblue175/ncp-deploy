name: Deploy to NCP (WAR)
on:
  push:
    branches: [ "master" ]
 
jobs:
  deploy:
    runs-on: ubuntu-latest
 
    defaults:
      run:
        working-directory: ./SpringBoot1
 
    steps:
      # 1. 코드 체크아웃
      - name: Checkout source code
        uses: actions/checkout@v3
 
      # 2. JDK 17 설정
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
 
      # 3. SSH 키 설정 (Bastion)
      - name: Setup SSH key for Bastion
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.BASTION_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.BASTION_HOST }} >> ~/.ssh/known_hosts
        working-directory: . # 루트에서 실행
 
      # 4. Maven 빌드
      - name: Make mvnw executable
        run: chmod +x ./mvnw
 
      - name: Build Spring Boot app with Maven (WAR)
        run: ./mvnw clean package -DskipTests
 
      - name: List WARs built (debug)
        run: ls -lh target/
 
      # 5. [수정] WAR 파일 Bastion 서버로 1차 전송
      - name: Copy WAR to bastion server
        run: |
          scp target/SpringBoot1-0.0.1-SNAPSHOT.war ${{ secrets.BASTION_USER }}@${{ secrets.BASTION_HOST }}:/tmp/app.war
 
      # 6. [수정] Bastion 서버에서 Private 서버로 2차 전송 및 배포
      - name: SSH into bastion and deploy to private server
        run: |
          set -x
          echo "SSH into bastion host and run commands..."
          ssh ${{ secrets.BASTION_USER }}@${{ secrets.BASTION_HOST }} << 'EOF'
            echo "Copying app.war from bastion to private server..."
            # [핵심] Host key 검사 스킵 옵션 추가
            scp -o StrictHostKeyChecking=no /tmp/app.war root@10.1.2.6:/root/app.war
            echo "Running deploy.sh on private server..."
            # [핵심] Host key 검사 스킵 옵션 추가
            ssh -o StrictHostKeyChecking=no root@10.1.2.6 'bash /root/deploy.sh'
          EOF
        working-directory: . # 루트에서 실행